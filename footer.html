<?php
require_once '../include/connection.php';

$message = '';

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    try {
        // Validate and sanitize input
        $title = filter_input(INPUT_POST, 'title', FILTER_SANITIZE_STRING);
        $post_date = filter_input(INPUT_POST, 'post_date', FILTER_SANITIZE_STRING);
        $description = filter_input(INPUT_POST, 'description', FILTER_SANITIZE_STRING);
        $ingredients = filter_input(INPUT_POST, 'ingredients', FILTER_SANITIZE_STRING);
        $instructions = filter_input(INPUT_POST, 'instructions', FILTER_SANITIZE_STRING);
        $cook_time = filter_input(INPUT_POST, 'cook_time', FILTER_SANITIZE_STRING);
        $serving_size = filter_input(INPUT_POST, 'serving_size', FILTER_SANITIZE_STRING);

        // Handle featured image upload
        $featured_image = '';
        if (isset($_FILES['featured_image']) && $_FILES['featured_image']['error'] === UPLOAD_ERR_OK) {
            $uploadDir = '../uploads/blog/';
            $imageFileType = strtolower(pathinfo($_FILES['featured_image']['name'], PATHINFO_EXTENSION));
            $imageName = uniqid() . '.' . $imageFileType;
            $uploadFile = $uploadDir . $imageName;

            // Validate image type
            if (in_array($imageFileType, ['jpg', 'jpeg', 'png', 'gif'])) {
                if (move_uploaded_file($_FILES['featured_image']['tmp_name'], $uploadFile)) {
                    $featured_image = $imageName;
                } else {
                    $message = "Error: Failed to move uploaded file.";  
                }
            } else {
                $message = "Error: Invalid file type. Only JPG, JPEG, PNG, and GIF are allowed.";
            }
        } else if (isset($_FILES['featured_image']) && $_FILES['featured_image']['error'] !== UPLOAD_ERR_OK) {
            $message = "Error: File upload failed: " . $_FILES['featured_image']['error'];
        }

        if (empty($message)) {
            // Insert recipe post into database
            $stmt = $pdo->prepare("
                INSERT INTO blog_posts (
                    user_id, title, post_date, description, ingredients, 
                    instructions, featured_image, created_at,
                    cook_time, serving_size
                ) VALUES (
                    ?, ?, ?, ?, ?, ?, ?, NOW(), ?, ?
                )
            ");

        

            $message = 'Recipe post added successfully!';
            header("Location: admin-dashboard.php");
            exit();
        }

    } catch (PDOException $e) {
        $message = 'Error adding recipe post: ' . $e->getMessage();
    }
}
?>

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Add New Recipe - Bites of Brilliance</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
    <style>
        /* Reusing the style from your first page */
        .form-container {
            max-width: 800px;
            margin: 2rem auto;
            padding: 2rem;
            background: white;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 1.5rem;
        }

        .form-col {
            flex: 1;
        }

        label {
            display: block;
            margin-bottom: 0.5rem;
            color: #333;
        }

        input[type="text"],
        input[type="date"],
        input[type="number"],
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        textarea {
            min-height: 150px;
        }

        .textarea-tall {
            min-height: 300px;
        }

        .btn-submit {
            background: #ff6f61;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1rem;
        }

        .btn-submit:hover {
            background: #ff5945;
        }

        .message {
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 4px;
            color: white;
        }

        .message.success {
            background: #28a745;
        }

        .message.error {
            background: #dc3545;
        }

        .image-preview {
            margin-top: 1rem;
            border: 1px dashed #ddd;
            padding: 10px;
            text-align: center;
            display: none;
        }

        .image-preview img {
            max-width: 100%;
            max-height: 200px;
        }

        h1 {
            color: #ff6f61;
            margin-bottom: 1.5rem;
        }

        .hint {
            font-size: 0.85rem;
            color: #777;
            margin-top: 0.3rem;
        }
    </style>
</head>
<body>
    <div class="form-container">
        <h1>Add New Recipe</h1>
        
        <?php if ($message): ?>
            <div class="message <?php echo strpos($message, 'Error') !== false ? 'error' : 'success'; ?>">
                <?php echo htmlspecialchars($message); ?>
            </div>
        <?php endif; ?>

        <form method="POST" enctype="multipart/form-data">
            <div class="form-group">
                <label for="title">Recipe Title</label>
                <input type="text" id="title" name="title" required>
            </div>

            <div class="form-row">
                <div class="form-col">
                    <label for="post_date">Date</label>
                    <input type="date" id="post_date" name="post_date" value="<?php echo date('Y-m-d'); ?>" required>
                </div>
                <div class="form-col">
                    <label for="cook_time">Cook Time (minutes)</label>
                    <input type="number" id="cook_time" name="cook_time" min="1">
                </div>
                <div class="form-col">
                    <label for="serving_size">Serving Size</label>
                    <input type="number" id="serving_size" name="serving_size" min="1">
                </div>
            </div>

            <div class="form-group">
                <label for="description">Description</label>
                <textarea id="description" name="description" required></textarea>
                <div class="hint">Briefly describe your recipe, including its origins or special features</div>
            </div>

            <div class="form-group">
                <label for="ingredients">Ingredients</label>
                <textarea id="ingredients" name="ingredients" class="textarea-tall" required></textarea>
                <div class="hint">List all ingredients with measurements, one per line</div>
            </div>

            <div class="form-group">
                <label for="instructions">Instructions</label>
                <textarea id="instructions" name="instructions" class="textarea-tall" required></textarea>
                <div class="hint">Write detailed step-by-step cooking instructions</div>
            </div>

            <div class="form-group">
                <label for="featured_image">Featured Image</label>
                <input type="file" id="featured_image" name="featured_image" accept="image/*" onchange="previewImage(this)">
                <div id="imagePreview" class="image-preview">
                    <img id="imgPreview" src="#" alt="Image Preview">
                </div>
            </div>

            <button type="submit" class="btn-submit">Publish Recipe</button>
        </form>
    </div>

    <script>
        function previewImage(input) {
            const preview = document.getElementById('imagePreview');
            const img = document.getElementById('imgPreview');
            
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                
                reader.onload = function(e) {
                    img.src = e.target.result;
                    preview.style.display = 'block';
                };
                
                reader.readAsDataURL(input.files[0]);
            } else {
                preview.style.display = 'none';
            }
        }
    </script>
</body>
</html>
cdnjs.cloudflare.com
